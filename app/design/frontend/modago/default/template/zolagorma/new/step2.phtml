<?php $_helper = Mage::helper("zolagorma"); ?>
<?php $_po = $this->getPo(); ?>
<?php $_rma = $this->getRma();?>
<?php $_shippingAddress = $_po->getShippingAddress(); ?>
<?php $_itemsSingle = $_rma->getItemsSingle(); ?>
<?php $_itemsConditionSingle = $_rma->getItemsConditionSingle(); ?>
<?php $items = $this->getItemList();?>
<?php $dateList = $this->getDateList();?>
<?php $weekdays = Mage::app()->getLocale()->getOptionWeekdays();?>
<div class="steps step-2 background-wrapper box-wrapper" id="step-2">
    <div class="rma-container">
		<?php if (($this->isDhlEnabled()) && count($dateList)) : ?>
        <div id="pickup-address-form" class="fieldset flow-return">
            <input type="hidden" name="rma[shipping_address_id]" value="<?php echo $_shippingAddress->getId(); ?>"/>
            <input type="hidden" name="rma[override_address]" value="0"/>

            <h3 class="legend"><?php echo $_helper->__("Confirm or change pickup address for the courier"); ?></h3>

            <div class="panel panel-default">
                <div class="panel-body">
                    <div class="current-rma-address current-addres clearfix">

                        <dl class="pull-left" id="shipping-address">
                            <dt><?php echo $_shippingAddress->getFirstname(); ?> <?php echo $_shippingAddress->getLastname(); ?></dt>
                            <dd><?php echo $_shippingAddress->getData("street"); ?></dd>
                            <dd><?php echo $_shippingAddress->getPostcode(); ?> <?php echo $_shippingAddress->getCity(); ?></dd>
                            <dd class="separator phone">
                                <?php echo $this->__('Contact phone'); ?>
                                : <span><?php echo $_shippingAddress->getTelephone(); ?>
                        </span>
                            </dd>
                        </dl>
                    </div>

                </div>
                <div class="panel-footer clearfix">
                    <a class="underline pull-right change_address shipping" href="#">
                        <?php echo $_helper->__("Change address"); ?> [dev]
                    </a>
                </div>
            </div>

        </div>
        <div id="pickup-date-form">
            <h3 class="legend"><?php echo $_helper->__("Schedule pickup date that is convenient for you"); ?></h3>
            <div class="panel panel-default">
                <div class="panel-body">
                    <div class="current-rma-date clearfix">
                        <div id="pickup-date-form-panel" class="fieldset flow-return">

                            <label class="required choose-date" for="carrier-date"><?php echo $_helper->__("Choose the date"); ?>
                                <em>:</em></label>

                            <div class="input-box">
								<?php foreach ($dateList as $date=>$item): ?>
                                    <input
                                        type="radio"
                                        name="rma[carrier_date]"
                                        id="carrier_date_<?php echo $date;?>"
                                        value="<?php echo date('Y-m-d',$date);?>"
                                        />
									<label for="carrier_date_<?php echo $date;?>">
                                        <span>
										    <span class="rma-dayname"><?php echo $weekdays[date('w',$date)]['label'];?></span>
                                            <br/>
										    <span class="rma-date"><?php echo $this->getFormattedDate($date);?></span>
									    </span>
									</label>



								<?php endforeach; ?>
<?php /*
                                <input type="text" value="<?php echo $_rma->getCarrierDate(); ?>"
                                       name="rma[carrier_date]" value="<?php echo $this->formatDate(); ?>"
                                       id="carrier-date" title="<?php echo $_helper->__("Choose the date"); ?>" value=""
                                       class="input-text required-entry ">
*/?>
                            </div>

                            <label class="required carrier-time-from"
                                   for="carrier-time-from"><?php echo $_helper->__("Select the time interval (min. 3h)"); ?>
                                <em>:</em></label>
                            <div class="choose-time">
                                <div class="field">
                                    <div class="input-box">
                                        <input type="hidden" name="rma[carrier_time_from]" id="carrier-time-from"
                                               value="<?php echo $_rma->getCarrierTimeFrom(); ?>"
                                               title="<?php echo $_helper->__("Choose time-from of the day"); ?>"/>
                                        <input type="hidden" name="rma[carrier_time_to]" id="carrier-time-to"
                                               value="<?php echo $_rma->getCarrierTimeTo(); ?>"
                                               title="<?php echo $_helper->__("Choose time-to of the day"); ?>"/>
                                    </div>
                                    <div id="pickup-time"></div>
                                    <br/>
                                    <div id="time"></<div>

                                </div>
                                <div id="slider-range"></div>
                            </div>
                        </div>

                    </div>
                </div>

            </div>
        </div>

		<?php endif;?>
        <div class="fieldset">
            <h3 class="legend"><?php echo $_helper->__("Enter your account number for your order refund"); ?></h3>
            <input type="text" value="<?php echo $this->escapeHtml($_rma->getCustomerAccount()); ?>"
                   name="rma[customer_account]" value="" id="customer-account"
                   title="<?php echo $_helper->__("Bank account"); ?>" value="" class="input-text">
        </div>
    </div>
    <div class="rma-container">
        <a href="#step-1" class="button button-third large back pull-left">
            <?php echo $_helper->__("Back"); ?>
        </a>
        <button class="btn button button-primary next pull-right"
                type="button"><?php echo $_helper->__("Next"); ?></button>
    </div>
</div>



<script type="text/javascript">
    var isAcknowledged = false;
</script>
<?php  $vendor = $_po->getVendor();?>

<script type="text/javascript">
    Mall.translate.add("Selected time", "<?php echo $_helper->__('Selected time') ?>");

    jQuery('#pickup-date-form-panel input').click(function() {
        var from = parseInt(jQuery(this).attr('data-PickupFrom'))*60;
        var to = parseInt(jQuery(this).attr('data-Pickupto'))*60;

        jQuery("#slider-range").noUiSlider({
            start: [ from, from + (3*60) ],
            range: {
                'min':  from,
                'max':  to
            }
        }, true);
        setPickupTime(jQuery(this).attr('data-PickupFrom'), jQuery(this).attr('data-PickupTo'))
    });



    //
    <?php $js_array = json_encode($dateList); ?>
    var dataList = <?php echo $js_array; ?>;
    for(var day in dataList) {
        jQuery('#carrier_date_' + day).attr('data-PickupFrom', dataList[day].getPostalCodeServicesResult.drPickupFrom );
        jQuery('#carrier_date_' + day).attr('data-PickupTo', dataList[day].getPostalCodeServicesResult.drPickupTo );
    }


    //applyFlow
    var returnReasons = '<?php echo Mage::helper("zolagorma")->getReturnReasons($_po, true); ?>';
    var flowAcknowledged = '<?php echo Zolago_Rma_Model_Rma::FLOW_ACKNOWLEDGED; ?>';

    jQuery("select[name^='rma[items_condition_single]']").each(function(item){
        if(item.value){
            if(returnReasons[item.value].flow == flowAcknowledged){
                isAcknowledged = true;
            }
        }
    })

    if(isAcknowledged){
        jQuery('#pickup-address-form').hide();
        jQuery('#pickup-date-form').hide();
        jQuery('#pickup-address-overview').hide();
        jQuery('#pickup-date-overview').hide();
        jQuery('#overview-message').hide();
    }
    else{
        jQuery('#pickup-address-form').show();
        jQuery('#pickup-date-form').show();
        jQuery('#pickup-address-overview').show();
        jQuery('#pickup-date-overview').show();
        jQuery('#overview-message').show();
    }

    jQuery("#slider-range").noUiSlider({
        start: [ 660, 840 ],
        step: 60,
        behaviour: 'drag-fixed',
        connect: true,
        range: {
            'min':  540,
            'max':  1200
        }
    });

    jQuery("#slider-range").on({
        slide: function() {
            var values = jQuery(this).val();
            var from = values[0];
            var to = values[1];
            formatTimeRange(from, to);
        }
    });

    function formatTimeRange(from, to){
        var minutes0 = parseInt(from % 60, 10),
            hours0 = parseInt(from / 60 % 24, 10),
            minutes1 = parseInt(to % 60, 10),
            hours1 = parseInt(to / 60 % 24, 10);


        var startTime = getTime(hours0, minutes0);
        var endTime = getTime(hours1, minutes1);
        var message =   Mall.translate.__("Selected time") + ': '+ startTime + ' - ' + endTime;
        jQuery("#time").html(message);

        jQuery('[name="rma[carrier_time_from]"]').val(startTime);
        jQuery('[name="rma[carrier_time_to]"]').val(endTime);

    }

    function getTime(hours, minutes) {
        minutes = minutes + "";
        if (minutes.length == 1) {minutes = "0" + minutes;}
        return hours + ":" + minutes;
    }

    var values = jQuery("#slider-range").val();
    formatTimeRange(values[0], values[1]);

    function setPickupTime(from, to) {
        jQuery('#pickup-time').text('Dla Twojego adresu, dostępne są terminy od ' + from + ' do ' + to);
    }

    jQuery(document).ready( function() {
        jQuery('#pickup-date-form-panel input').first().click();//default set the first day

//        var from =
//        setPickupTime()
    });

</script>

<style>

    /* Functional styling;
     * These styles are required for noUiSlider to function.
     * You don't need to change these rules to apply your design.
     */
    .noUi-target,
    .noUi-target * {
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -ms-touch-action: none;
        -ms-user-select: none;
        -moz-user-select: none;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
    }
    .noUi-target {
        position: relative;
    }
    .noUi-base {
        width: 100%;
        height: 100%;
        position: relative;
    }
    .noUi-origin {
        position: absolute;
        right: 0;
        top: 0;
        left: 0;
        bottom: 0;
    }
    .noUi-handle {
        position: relative;
        z-index: 1;
    }
    .noUi-stacking .noUi-handle {
        /* This class is applied to the lower origin when
           its values is > 50%. */
        z-index: 10;
    }
    .noUi-stacking + .noUi-origin {
        /* Fix stacking order in IE7, which incorrectly
           creates a new context for the origins. */
        *z-index: -1;
    }
    .noUi-state-tap .noUi-origin {
        -webkit-transition: left 0.3s, top 0.3s;
        transition: left 0.3s, top 0.3s;
    }
    .noUi-state-drag * {
        cursor: inherit !important;
    }

    /* Painting and performance;
     * Browsers can paint handles in their own layer.
     */
    .noUi-base {
        -webkit-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
    }

    /* Slider size and handle placement;
     */
    .noUi-horizontal {
        height: 18px;
    }
    .noUi-horizontal .noUi-handle {
        width: 34px;
        height: 28px;
        left: -17px;
        top: -6px;
    }
    .noUi-vertical {
        width: 18px;
    }
    .noUi-vertical .noUi-handle {
        width: 28px;
        height: 34px;
        left: -6px;
        top: -17px;
    }

    /* Styling;
     */
    .noUi-background {
        background: #FAFAFA;
        box-shadow: inset 0 1px 1px #f0f0f0;
    }
    .noUi-connect {
        background: #6fffcf;
        box-shadow: inset 0 0 3px rgba(51,51,51,0.45);
        -webkit-transition: background 450ms;
        transition: background 450ms;
    }
    .noUi-origin {
        border-radius: 2px;
    }
    .noUi-target {
        border-radius: 4px;
        border: 1px solid #D3D3D3;
        box-shadow: inset 0 1px 1px #F0F0F0, 0 3px 6px -5px #BBB;
    }
    .noUi-target.noUi-connect {
        box-shadow: inset 0 0 3px rgba(51,51,51,0.45), 0 3px 6px -5px #BBB;
    }

    /* Handles and cursors;
     */
    .noUi-dragable {
        cursor: w-resize;
    }
    .noUi-vertical .noUi-dragable {
        cursor: n-resize;
    }
    .noUi-handle {
        border: 1px solid #D9D9D9;
        border-radius: 3px;
        background: #FFF;
        cursor: default;
        box-shadow: inset 0 0 1px #FFF,
        inset 0 1px 7px #EBEBEB,
        0 3px 6px -3px #BBB;
    }
    .noUi-active {
        box-shadow: inset 0 0 1px #FFF,
        inset 0 1px 7px #DDD,
        0 3px 6px -3px #BBB;
    }

    /* Handle stripes;
     */
    .noUi-handle:before,
    .noUi-handle:after {
        content: "";
        display: block;
        position: absolute;
        height: 14px;
        width: 1px;
        background: #E8E7E6;
        left: 14px;
        top: 6px;
    }
    .noUi-handle:after {
        left: 17px;
    }
    .noUi-vertical .noUi-handle:before,
    .noUi-vertical .noUi-handle:after {
        width: 14px;
        height: 1px;
        left: 6px;
        top: 14px;
    }
    .noUi-vertical .noUi-handle:after {
        top: 17px;
    }

    /* Disabled state;
     */
    [disabled].noUi-connect,
    [disabled] .noUi-connect {
        background: #B8B8B8;
    }
    [disabled] .noUi-handle {
        cursor: not-allowed;
    }
</style>
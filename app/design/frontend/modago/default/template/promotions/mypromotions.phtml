<?php
/** @var Zolago_Modago_Block_Mypromotions $this */
/** @var Zolago_Salesrule_Helper_Data $helper */
$helper = Mage::helper('zolagosalesrule');
?>
<div id="content" class="container-fluid mypromotions-account-create account-create">
	<div class="row">
		<div id="content-main" class="section">
			<?php if ($this->isLogged()): ?>
				<?php $list = $this->getPromotionList(); ?>
				<div class="container-fluid">
					<div class="row">
						<section id="mypromotions-list"
						         class="main bg-w col-lg-8 col-md-10 col-sm-12 col-xs-12 col-lg-push-2 col-md-push-1">
							<header class="title-section">
								<?php echo $this->getLayout()->createBlock('cms/block')->setBlockId('mypromotions_list_header')->toHtml(); ?>
							</header>
							<?php if (count($list)): ?>
								<div id="promo_list">
									<?php foreach ($list as $item): ?>
										<div class="promo_item col-xs-6 col-sm-4 col-md-4 col-lg-4">
											<?php $imageName = $item['ruleItem']->getCampaignData()->getCouponImage(); ?>
											<?php if ($imageName): ?>
												<?php $imageResized = $helper->getResizedPromotionImage($imageName); ?>
												<?php $imageInfo = $helper->getResizedPromotionImageInfo($imageName); ?>
												<figure class="promo_img"
													<?php if (is_array($imageInfo) && isset($imageInfo['ratio'])): ?>
														style="padding-bottom: <?php echo $imageInfo['ratio']; ?>%;"
													<?php endif; ?>>
													<img src="<?php echo $imageResized; ?>"
													     alt="<?php echo $item['ruleItem']->getName(); ?>">
												</figure>
											<?php endif; ?>
											<div class="promo_info">
												<h3 class="promo_name">
													<?php echo $item['ruleItem']->getName(); ?>
												</h3>

												<?php if ($item['ruleItem']->getDescription()): ?>
													<div class="promo_desc">
														<?php echo $item['ruleItem']->getDescription(); ?>
													</div>
												<?php endif; ?>

												<div class="promo_desc">
													<?php $date = date('d.m.Y', strtotime($item['ruleItem']->getToDate())); ?>
													<?php echo $helper->__("Expiration date:") . " " . $date ?>
												</div>

												<?php if ($this->isLogged()) : ?>
													<div class="promo_code">
														<?php echo $helper->__('Your coupon code:'); ?>
														<textarea readonly><?php echo $item['code']; ?></textarea>
													</div>
												<?php else: ?>
													<div class="promo_code_hidden">
														<?php echo $helper->__('Login to see your coupon code'); ?>
													</div>
												<?php endif; ?>

											</div>
										</div>
									<?php endforeach; ?>
								</div>
							<?php else: ?>
								<div id="no_promo_list">
									<?php echo $this->getLayout()->createBlock('cms/block')->setBlockId('mypromotions_nocoupons')->toHtml(); ?>
								</div>
							<?php endif; ?>
							</section>
						</div>
					</div>
				<?php
				/** @var Zolago_Salesrule_Helper_Data $salesruleHelper */
				$salesruleHelper = Mage::helper('zolagosalesrule');
				?>
				<?php if(!$this->isSubscribed() && $salesruleHelper->areCouponsForCustomerAvailable($this->getCustomerId())): ?>
					<div class="container-fluid">
						<div class="row">
							<section class="main bg-w mypromotions-cms col-lg-8 col-md-10 col-sm-12 col-xs-12 col-lg-push-2 col-md-push-1">
								<?php echo $this->getLayout()->createBlock('cms/block')->setBlockId('mypromotions_notsubscribed')->toHtml(); ?>
								<div class="row">
									<?php echo $this->getChildHtml('mypromotions.newsletter'); ?>
								</div>
							</section>
						</div>
					</div>
				<?php endif; ?>
				<?php echo $this->getCmsBlock(); ?>
				<?php if (count($list)): ?>
					<script>
						jQuery(document).ready(function () {
							jQuery('#promo_list')
								.on('done.shuffle', function () {
									jQuery(window).resize();
								})
								.shuffle({throttleTime: 250, speed: 0, easing: 'linear'});
						});
					</script>
				<?php endif; ?>
			<?php elseif ($this->isPersistent()): ?>
				<?php echo $this->getChildHtml('mypromotions.gotologin'); ?>
				<?php echo $this->getCmsBlock(); ?>
				<?php echo $this->getChildHtml('mypromotions.gotoregister'); ?>
			<?php
			else: ?>
				<?php echo $this->getCmsBlock(); ?>
				<?php echo $this->getChildHtml('mypromotions.register'); ?>
				<?php echo $this->getChildHtml('mypromotions.gotologin'); ?>
			<?php endif; ?>
		</div>
	</div>
</div>
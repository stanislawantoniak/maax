<?php
/** @var $this ZolagoOs_LoyaltyCard_Block_Vendor_Card_Edit */
/** @var ZolagoOs_LoyaltyCard_Model_Card $card */
$card = $this->getModel();
/** @var ZolagoOs_LoyaltyCard_Helper_Data $helper */
$helper = Mage::helper("zosloyaltycard");

/**
 * Why this here?
 * Each vendor have his own skin and different business requirement for this form
 * (so now we don't need to override object block)
 *
 * @param $object
 * @return Zolago_Dropship_Model_Form
 */
function _prepareForm($object) {
	/** @var ZolagoOs_LoyaltyCard_Helper_Data $helper */
	$helper = Mage::helper("zosloyaltycard");

	/** @var Zolago_Dropship_Model_Form $form */
	$form = Mage::getModel('zolagodropship/form');

	// +10 years by default
	if(!$object->getModel()->hasData('expire_date')) {
		$object->getModel()->setData('expire_date', date("d-m-Y", time() + 60*60*24*365*10));
	}
	$values = $object->getModel()->getData();

	$general = $form->addFieldset("general", array(
		"legend" => $helper->__("Card data"),
		"icon_class" => "icon-double-angle-right"
	));

	$general->addField("card_number", "text", array(
		"name" => "card_number",
		"class" => "form-control",
		"required" => true,
		"label" => $helper->__('Card number'),
		"label_wrapper_class" => "col-md-3",
		"wrapper_class" => "col-md-2"
	));

	$general->addField("receipt_number", "text", array(
		"name" => "receipt_number",
		"class" => "form-control",
		"required" => true,
		"label" => $helper->__('Receipt number'),
		"label_wrapper_class" => "col-md-3",
		"wrapper_class" => "col-md-2"
	));

	$general->addField("receipt_value", "text", array(
		"name" => "receipt_value",
		"class" => "form-control",
		"required" => true,
		"label" => $helper->__('Receipt value'),
		"label_wrapper_class" => "col-md-3",
		"wrapper_class" => "col-md-1"
	));

	$general->addField("shop_code", "text", array(
		"name" => "shop_code",
		"class" => "form-control",
		"required" => true,
		"label" => $helper->__('Shop code'),
		"label_wrapper_class" => "col-md-3",
		"wrapper_class" => "col-md-1"
	));

	$general->addField("expire_date", "text", array(
		"name" => "expire_date",
		"class" => "form-control datetimepicker col-md-2",
		"required" => true,
		"label" => $helper->__('Expire date'),
		"label_wrapper_class" => "col-md-3",
		"wrapper_class" => "col-md-5 datetimepicker-wrapper",
		"after_element_html" => '<label style="margin: 8px;"><i class="icon-calendar"></i></label>',
	));

	// todo: change type
	$general->addField("card_type", "text", array(
		"name" => "card_type",
		"class" => "form-control",
		"required" => true,
		"label" => $helper->__('Card type'),
		"label_wrapper_class" => "col-md-3",
		"wrapper_class" => "col-md-1"
	));

	$client = $form->addFieldset("client", array(
		"legend" => $helper->__("Client data"),
		"icon_class" => "icon-double-angle-right"
	));

	$client->addField("first_name", "text", array(
		"name" => "first_name",
		"class" => "form-control",
		"required" => true,
		"label" => $helper->__('First name'),
		"label_wrapper_class" => "col-md-3",
		"wrapper_class" => "col-md-3"
	));

	$client->addField("surname", "text", array(
		"name" => "surname",
		"class" => "form-control",
		"required" => true,
		"label" => $helper->__('Surname'),
		"label_wrapper_class" => "col-md-3",
		"wrapper_class" => "col-md-3"
	));

	$client->addField("sex", "radios", array(
		"name" => "sex",
		//"class" => "form-control",
		"required" => true,
		"label" => $helper->__('Sex'),
		"label_wrapper_class" => "col-md-3",
		"wrapper_class" => "col-md-6 radio-buttons",
		'value' => 'M',
		'values' => array(
			array('value' => 'M', 'label' => $helper->__('Male')),
			array('value' => 'F', 'label' => $helper->__('Female')),
		),
	));

	$client->addField("telephone_number", "text", array(
		"name" => "telephone_number",
		"class" => "form-control",
		"required" => true,
		"label" => $helper->__('Telephone number'),
		"label_wrapper_class" => "col-md-3",
		"wrapper_class" => "col-md-2"
	));

	$client->addField("email", "text", array(
		"name" => "email",
		"class" => "form-control",
		"required" => true,
		"label" => $helper->__('Email'),
		"label_wrapper_class" => "col-md-3",
		"wrapper_class" => "col-md-2"
	));

	$abode  = $form->addFieldset("abode", array(
		"legend" => $helper->__("Abode"),
		"icon_class" => "icon-double-angle-right"
	));

	$abode->addField("place", "text", array(
		"name" => "place",
		"class" => "form-control",
		"required" => true,
		"label" => $helper->__('Place'),
		"label_wrapper_class" => "col-md-3",
		"wrapper_class" => "col-md-4"
	));

	$abode->addField("zip_code", "text", array(
		"name" => "zip_code",
		"class" => "form-control",
		"required" => true,
		"label" => $helper->__('Zip code'),
		"label_wrapper_class" => "col-md-3",
		"wrapper_class" => "col-md-1"
	));

	$kids = $form->addFieldset("kids", array(
		"legend" => $helper->__("Kid/kids data"),
		"icon_class" => "icon-double-angle-right",
		"class" => "kids"
	));

	$count = 1;
	if (isset($values['kids'])) {
		$count = count($values['kids']);
	}

	for ($i = 0; $i < $count; $i++) {

		$kids->addField("kids_{$i}_first_name", "text", array(
			"name" => "kids[{$i}][first_name]",
			"class" => "form-control",
			"required" => true,
			"label" => $helper->__('First name'),
			"label_wrapper_class" => "col-md-3",
			"wrapper_class" => "col-md-3"
		));


		$kids->addField("kids_{$i}_sex", "radios", array(
			"name" => "kids[{$i}][sex]",
			//"class" => "form-control",
			"required" => true,
			"label" => $helper->__('Sex'),
			"label_wrapper_class" => "col-md-3",
			"wrapper_class" => "col-md-6 radio-buttons",
			'value' => 'M',
			'values' => array(
				array('value' => 'M', 'label' => $helper->__('Boy')),
				array('value' => 'F', 'label' => $helper->__('Girl')),
			),
		));

		$kids->addField("kids_{$i}_birthdate", "text", array(
			"name" => "kids[{$i}][birthdate]",
			"class" => "form-control datetimepicker col-md-2",
			"required" => true,
			"label" => $helper->__('Date of birth'),
			"label_wrapper_class" => "col-md-3",
			"wrapper_class" => "col-md-5 datetimepicker-wrapper",
			"after_element_html" => '<label style="margin: 8px;"><i class="icon-calendar"></i></label>',
		));
	}
	$form->setValues($values);
	return $form;
}
$form = _prepareForm($this);
?>

<div class="container">
	<div class="page-heading row">
		<div class="col-lg-12">
			<?php if ($this->isModelNew()): ?>
				<h3><?php echo $helper->__("New card"); ?></h3>
				<p><?php echo $helper->__("Create new card. Required fields are marked with an asterisk."); ?></p>
			<?php else: ?>
				<h3><?php echo $helper->__("Edit card '%s'", $card->getCardCode()); ?></h3>
				<p><?php echo $helper->__("Below you will find details of card. You can make changes to this cart by editing each field"); ?></p>
			<?php endif; ?>
		</div>
	</div>
</div>

<div class="container z-grid">
	<form id="edit-card" class="form-horizontal row-border" action="<?php echo $this->getSaveUrlAction(); ?>" method="POST">
		<input type="hidden" name="card_id" value="<?php echo $card->getId();?>"/>
		<?php echo $this->getLayout()->getBlock('formkey')->toHtml();?>
		<?php echo $form->toHtml(); ?>

		<div class="form-actions">
			<input type="submit" value="<?php echo $helper->__("Save");?>" class="btn btn-primary pull-right">
			<a href="<?php echo Mage::getUrl('*/*'); ?>" class="btn btn-default pull-right"><?php echo $helper->__("Cancel");?></a>
		</div>
	</form>
</div>
<script>
	var CardEdit = {
		init: function () {
			this.initDatetimepicker();
		},
		initDatetimepicker: function () {
			jQuery('.datetimepicker').datetimepicker({
				lang: _currentLocale == "pl_PL" ? 'pl' : 'en',
				format: 'd-m-Y'
			});
			jQuery(".icon-calendar").click(function () {
				jQuery(this).parents(".datetimepicker-wrapper").find(".datetimepicker")
					.datetimepicker("show")
					.blur();
			});
		}
	};

	jQuery(document).ready(function () {
		CardEdit.init();
	});
</script>
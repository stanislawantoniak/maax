<?php 
/**
 * ITORIS
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the ITORIS's Magento Extensions License Agreement
 * which is available through the world-wide-web at this URL:
 * http://www.itoris.com/magento-extensions-license.html
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to sales@itoris.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade the extensions to newer
 * versions in the future. If you wish to customize the extension for your
 * needs please refer to the license agreement or contact sales@itoris.com for more information.
 *
 * @category   ITORIS
 * @package    ITORIS_GROUPEDPRODUCTPROMOTIONS
 * @copyright  Copyright (c) 2013 ITORIS INC. (http://www.itoris.com)
 * @license    http://www.itoris.com/magento-extensions-license.html  Commercial License
 */
$_helper = Mage::helper("zolagocataloginventory");
?>
<?php /** @var $this Itoris_GroupedProductPromotions_Block_Product_View */ ?>
<?php if ($this->getDataHelper()->isRegisteredFrontend()) :?>
    <?php $usedRules = $this->getUsedRules(); ?>
    <?php if (is_array($usedRules)): ?>
        <?php
            $totalDiscountRule = 0;
            $totalPrice = 0;
        ?>
        <div id="itoris_used_promotion_rules_hidden" style="display: none;">
            <?php foreach ($usedRules as $index => $usedRule): ?>
                <div class="table-row clearfix" id="itoris_used_promotion_rule_<?php echo $index ?>">
                    <div class="colgroup-01 clearfix">
                        <div class="colgroup naglowek hidden-xs">
                            <div class="product"><?php echo $_helper->__("Product"); ?></div>
                        </div>
                        <div class="clearfix">
                            <?php echo $usedRule['title'];?>
                            <?php // dalej nie moje ?>
                            <?php $productsData = $this->getProductsData($usedRule, true); ?>
<!--                            --><?// Zend_Debug::dump($productsData); ?>
                            <?php foreach ($usedRule['product_config'] as $key => $config): ?>
                                <?php if(isset($productsData[$config['product_id']])) {$productData = $productsData[$config['product_id']]; } else {continue;} ?>
                                <?php
                                $tierPrice = $productData['tier_price'];
                                if (!$tierPrice) {
                                    $totalPrice += $this->getTotalPrice($config['qty'], $productData['final_price']);
                                } else {
                                    $totalPrice += $this->getTotalPrice($config['qty'], $tierPrice);
                                }
                                $totalDiscountRule += $productData['total_discount'];
                                ?>
                                <div class="itoris_groupedproductpromotions_product product_<?php echo $config['product_id'] ?>">
                                    <?php if ($productData['product_url']): ?><a href="<?php echo $productData['product_url'];?>"><?php endif; ?><img src="<?php echo $productData['image'];?>" style="padding-bottom: 5px;"><?php if ($productData['product_url']): ?></a><?php endif; ?>
                                    <div style="font-weight: bold; font-size: 12px"><?php echo $config['qty'] > 1 ? $config['qty'] . ' x ' : '';?><?php if ($productData['product_url']): ?><a href="<?php echo $productData['product_url'];?>"><?php else: ?><span><?php endif; ?><?php echo $productData['name'];?><?php if ($productData['product_url']): ?></a><?php else: ?></span><?php endif; ?></div>
                                    <span class="itoris_groupedproductpromotions_price">
											<span class="itoris_groupedproductpromotions_pricevalue"><?php echo Mage::app()->getStore()->formatPrice($tierPrice ? $tierPrice : $productData['final_price'], false);?></span>
										</span>
                                    <span style="color: red;"><?php echo $config['qty'] > 1 ? ' x ' . $config['qty'] : '';?></span>

                                    <?php if ($usedRule['price_method'] != 0): ?>
                                        <span class="itoris_groupedproductpromotions_discount"><?php echo Mage::app()->getStore()->formatPrice($productData['discount'], false) . ' ' ; echo $config['qty'] > 1 ?  $this->__('OFF each!') : $this->__('OFF!');?></span>
                                    <?php else: ?>
                                        <?php if ($config['type'] == Itoris_GroupedProductPromotions_Block_Product_View::TYPE_FIXED && $config['discount'] != 0){ ?>
                                            <span class="itoris_groupedproductpromotions_discount"><span class="itoris_groupedproductpromotions_pricevalue"><?php echo Mage::app()->getStore()->formatPrice($productData['discount'], false) . ' ';?></span><?php echo $config['qty'] > 1 ?  $this->__('OFF each!') : $this->__('OFF!');?></span>
                                        <?php } else if ($config['discount'] != 0) { ?>
                                            <span class="itoris_groupedproductpromotions_discount"><?php echo $config['discount'] .'% '; echo $config['qty'] > 1 ?  $this->__('OFF each!') : $this->__('OFF!');?></span>
                                        <?php } ?>
                                    <?php endif;?>
                                </div>
                                <?php if ($key != count($usedRule['product_config']) - 1): ?>
                                    <div class="itoris_groupedproductpromotions_plus"><span>+</span></div>
                                <?php endif;?>
                            <?php endforeach; ?>
                            <div id="itoris_used_promotion_rule_<?php echo $index ?>_qtys" style="display: none;" class="promotion-product-qtys"></div>
                            <?php // aż tutaj ?>
<!--                            <figure><a href="--><?php //echo $this->getProductUrl(); ?><!--"><img src="--><?php //echo $this->getProductThumbnail()->resize(53, 69); ?><!--" alt="--><?php //echo $this->escapeHtml($this->getProductName()) ?><!--" /></a></figure>-->
<!--                            <div class="description_checked_product">-->
<!--                                <div class="product_name"><a href="--><?php //echo $this->getProductUrl(); ?><!--">--><?php //echo $this->escapeHtml($this->getProductName()) ?><!--</a></div>-->
<!--                                --><?php //if ($_options = $this->getOptionList()):?>
<!--                                    --><?php //foreach ($_options as $_option) : ?>
<!--                                        --><?php //$_formatedOptionValue = $this->getFormatedOptionValue($_option) ?>
<!---->
<!--                                        <div class="product_size">--><?php //echo $this->escapeHtml($_option['label']) ?><!--: --><?php //echo $_formatedOptionValue['value'] ?>
<!--                                            --><?php //if (isset($_formatedOptionValue['full_view'])): ?>
<!--                                                <div class="truncated_full_value">-->
<!--                                                    --><?php //echo $this->escapeHtml($_option['label']) ?><!--:-->
<!--                                                    --><?php //echo $_formatedOptionValue['full_view'] ?>
<!--                                                </div>-->
<!--                                            --><?php //endif; ?>
<!--                                        </div>-->
<!--                                    --><?php //endforeach; ?>
<!--                                --><?php //endif;?>
<!--                                <div class="product_availability"><span class="--><?php //if($_helper->getQuoteItemAvailableFlag($_item) == Zolago_CatalogInventory_Helper_Data::FLAG_IN_STOCK) : ?><!--icons-checked--><?php //else :?><!--icons-interjection--><?php //endif; ?><!--">--><?php //echo $_helper->getQuoteItemAvailableText($_item);?><!--</span></div>-->
<!---->
<!--                                --><?php //$addInfoBlock = $this->getProductAdditionalInformationBlock(); ?>
<!--                                --><?php //if ($addInfoBlock): ?>
<!--                                    --><?php //echo $addInfoBlock->setItem($_item)->toHtml() ?>
<!--                                --><?php //endif;?>
<!--                            </div>-->
                        </div>
                    </div>
                    <div class="colgroup-02 clearfix">
                        <div class="colgroup naglowek">

                            <div class="cena"><?php echo $_helper->__("price"); ?></div>
                            <div class="ilosc"><?php echo $_helper->__("Qty"); ?></div>
                            <div class="wartosc"><?php echo $_helper->__("Worth"); ?></div>
                            <div class="usun"></div>

                        </div>
                        <div class="colgroup clearfix">
                            <div class="usun"><a href="<?php //echo $this->getDeleteUrl()?>" class="delet_product" title="<?php echo $_helper->__('Remove product')?>"><i class="fa fa-trash-o fa-1_4x"></i></a></div>
                            <div class="col">
                                <div class="cena">
                                    <span class="stara_cena" style="padding-top: 5px;"><?php echo $this->helper('checkout')->formatPrice($totalPrice); ?></span>
                                    <span class="cart-price"><?php echo $this->helper('checkout')->formatPrice($totalPrice - $totalDiscountRule); ?></span>
                                </div>
                                <div class="ilosc">
                                    <div class="quantity_blocks product_<?php echo $usedRule['product_id']; ?>">
                                        <a href="#" class="qty_less" onClick="Cart.less(<?php //echo $usedRule['product_id']; ?>);return false;">-</a>
                                        <div class="qty"><input type="text" name="cart_g[<?php echo $index; ?>][qty]" old-value="<?php //echo $this->getQty($_item); ?>" value="<?php //echo $this->getQty($_item); ?>" data-id="<?php echo $usedRule['product_id']; ?>" data-max-sale-qty="<?php //echo $_helper->getMaxSaleQty($_item); ?>" data-min-sale-qty="1"/></div>
                                        <a href="#" class="qty_more" onClick="Cart.more(<?php //echo $usedRule['product_id']; ?>);return false;">+</a>
                                        <label id="qty-error" class="error"><?php //echo $_helper->__("Maximum quantity: %s", 12); //$_helper->getMaxSaleQty($_item)?></label>
                                    </div>
                                </div>

                                <!--Sub total starts here -->
                                <div class="a-right bold" style="padding-top:5px;">
                                    <span class="cart-price price-sum">to wyliczyć, bo ilośc ???</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            <?php endforeach; ?>
            <script type="text/javascript">
                var usedItorisPromotionsRules = <?php echo (Mage::getSingleton('itoris_groupedproductpromotions/quote_observer')->getUsedRulesJson()) ?>;
//                jQuery(function(){
                    var qtyInputs = jQuery('#shopping-cart .qty input');
                    for (var i = 0; i < usedItorisPromotionsRules.length; i++) {
                        for (var j = 0; j < usedItorisPromotionsRules[i].items.length; j++) {
                            for (var z = 0; z < qtyInputs.length; z++) {
                                if (qtyInputs[z].name == 'cart[' + usedItorisPromotionsRules[i].items[j].item_id + '][qty]') {
                                    var prod = qtyInputs[z].closest(".table-row");
                                    jQuery('#itoris_used_promotion_rule_' + i + '_qtys')[0].appendChild(qtyInputs[z]);
                                    qtyInputs[z].rule_orig_qty = usedItorisPromotionsRules[i].items[j].item_orig_qty;
                                    prod.remove();
                                }
                            }
                        }
                    }
                    for (var i = 0; i < usedItorisPromotionsRules.length; i++) {
                        jQuery(".table-cart > .table-footer-group").first().before(jQuery('#itoris_used_promotion_rule_' + i)[0]);
                        jQuery('#itoris_used_promotion_rule_' + i + ' .price-sum').text(usedItorisPromotionsRules[i].rule_total_price_formatted);
                        jQuery('input[name="cart_g[' + i + '][qty]"]').val(usedItorisPromotionsRules[i].rule_qty);

                    }
//                });
            </script>
        </div>
    <?php endif; ?>
<?php endif;?>
<?php 
/**
 * ITORIS
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the ITORIS's Magento Extensions License Agreement
 * which is available through the world-wide-web at this URL:
 * http://www.itoris.com/magento-extensions-license.html
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to sales@itoris.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade the extensions to newer
 * versions in the future. If you wish to customize the extension for your
 * needs please refer to the license agreement or contact sales@itoris.com for more information.
 *
 * @category   ITORIS
 * @package    ITORIS_GROUPEDPRODUCTPROMOTIONS
 * @copyright  Copyright (c) 2013 ITORIS INC. (http://www.itoris.com)
 * @license    http://www.itoris.com/magento-extensions-license.html  Commercial License
 */

 
?>
<?php /** @var $this Itoris_GroupedProductPromotions_Block_Product_View */ ?>
<?php if ($this->getDataHelper()->isRegisteredFrontend()) :?>

    <script type="text/javascript" src="<?php echo Mage::getBaseUrl('js') ?>itoris/groupedproductpromotions/promotions.js"></script>
    <script type="text/javascript">itorisGroupedPromoOptions = [];/* opConfig = {reloadPrice : function(){}}; spConfig = {reloadPrice : function(){}}; bundle = {reloadPrice : function(){}};*/</script>
    <link rel="stylesheet" type="text/css" href="<?php echo Mage::getDesign()->getSkinUrl('itoris/groupedproductpromotions/css/promotions.css', array()) ?>"/>
    <?php $getRules  = $this->getRules(); $promoDataForJs = array();?>
    <?php $priceFormat  = Mage::app()->getLocale()->getJsPriceFormat();?>
    <?php $qtyCurrentProduct = array(); ?>
    <?php if (!empty($getRules)): ?>
    <div class="box-collateral box-itoris-product-promotions">
        <?php if (!$this->isCms()): ?>
            <h2><?php echo $this->__('Our Promotions');?></h2>
        <?php endif; ?>
            <?php foreach ($getRules as $value): ?>
                <?php if ($this->correctDate($value['active_from'], $value['active_to'])
                    && $value['status'] == Itoris_GroupedProductPromotions_Block_Product_View::STATUS_ACTIVE
                    && $this->customerGroup($value['group_ids'])
                    ):
                ?>
                    <?php $totalDiscountRule = 0; ?>
                    <?php $totalPrice = 0; ?>
                    <?php if (!array_key_exists($value['rule_id'], $promoDataForJs)) {$promoDataForJs[$value['rule_id']] = array(); }?>

                <form action="<?php echo Mage::getUrl('groupedproductpromotions/cart/add', array('rule_id' => $value['rule_id'])); ?>" method="post" id="itoris_promotions_product_addtocart_form_<?php echo $value['rule_id']?>" class="itoris_groupedproductpromotions_form">
                    <table style="width: 100%">
                    <tr><th class="itoris_groupedproductpromotions_title"><?php echo $value['title'];?></th></tr>
                    <tr>
                        <td style="width: 75%; padding-bottom: 10px;">
                            <?php $productsData = $this->getProductsData($value) ?>
                            <?php foreach ($value['product_config'] as $key => $config): ?>
                                <?php if(isset($productsData[$config['product_id']])) {$productData = $productsData[$config['product_id']]; } else {continue;} ?>
                                <?php
                                    $tierPrice = $productData['tier_price'];
                                    if (!$tierPrice) {
                                        $totalPrice += $this->getTotalPrice($config['qty'], $productData['final_price']);
                                    } else {
                                        $totalPrice += $this->getTotalPrice($config['qty'], $tierPrice);
                                    }
                                    $totalDiscountRule += $productData['total_discount'];
                                $price = $tierPrice ? $tierPrice : $productData['final_price'];
                                $promoDataForJs[$value['rule_id']][] = array(
                                    'product_id' => $config['product_id'],
                                    'price' => $price,
                                    'price_promo' => $price - $productData['discount'],
                                    'qty' => $config['qty'],
                                    'type_discount' => $config['type'],
                                    'discount' => $config['discount'],
                                );
                                if (!array_key_exists('rule', $promoDataForJs)) {
                                    $promoDataForJs['rule'] = array();
                                }
                                if (!array_key_exists($value['rule_id'], $promoDataForJs['rule'])) {
                                    $promoDataForJs['rule'][$value['rule_id']] = array(
                                        'price_method'      => (int)$value['price_method'],
                                        'discount_promoset' => $value['discount_promoset'],
                                        'code_promoset'     => (int)$value['code_promoset'],
                                        'fixed_price'       => $value['fixed_price']
                                    );
                                }
                                ?>
                                <div class="itoris_groupedproductpromotions_product">
                                    <?php if ($productData['product_url']): ?><a href="<?php echo $productData['product_url'];?>"><?php endif; ?><img src="<?php echo $productData['image'];?>"><?php if ($productData['product_url']): ?></a><?php endif; ?>
                                    <div><?php echo $config['qty'] > 1 ? $config['qty'] . ' x ' : '';?><?php if ($productData['product_url']): ?><a href="<?php echo $productData['product_url'];?>"><?php else: ?><span><?php endif; ?><?php echo $productData['name'];?><?php if ($productData['product_url']): ?></a><?php else: ?></span><?php endif; ?></div>
                                    <div class="price-box">
                                        <span class="itoris_groupedproductpromotions_price" id="promo-product-price-<?php echo $config['product_id'] . '-' . $value['rule_id'];?>">
                                            <span class="itoris_groupedproductpromotions_pricevalue price"><?php echo Mage::app()->getStore()->formatPrice($tierPrice ? $tierPrice : $productData['final_price'], false);?></span>
                                        </span>
                                        <span style="color: red;"><?php echo $config['qty'] > 1 ? ' x ' . $config['qty'] : '';?></span>
                                    </div>
                                    <?php if ($value['price_method'] != 0): ?>
                                        <span class="itoris_groupedproductpromotions_discount"><?php echo Mage::app()->getStore()->formatPrice($productData['discount'], false) . ' ' ; echo $config['qty'] > 1 ?  $this->__('OFF each!') : $this->__('OFF!');?></span>
                                    <?php else: ?>
                                    <?php if ($config['type'] == Itoris_GroupedProductPromotions_Block_Product_View::TYPE_FIXED && $config['discount'] != 0){ ?>
                                        <span class="itoris_groupedproductpromotions_discount"><span class="itoris_groupedproductpromotions_pricevalue"><?php echo Mage::app()->getStore()->formatPrice($productData['discount'], false) . ' ';?></span><?php echo $config['qty'] > 1 ?  $this->__('OFF each!') : $this->__('OFF!');?></span>
                                    <?php } else if ($config['discount'] != 0) { ?>
                                        <span class="itoris_groupedproductpromotions_discount"><?php echo $config['discount'] .'% '; echo $config['qty'] > 1 ?  $this->__('OFF each!') : $this->__('OFF!');?></span>
                                    <?php } ?>
                                    <?php endif;?>
                                    <?php if ($productData['has_options']): ?>
                                        <script type="text/javascript">
                                            if(typeof Product=='undefined') {
                                                var Product = {};
                                            }
                                            var optionsPrice<?php echo $config['product_id'] . '_' . $value['rule_id'];?> = new Product.OptionsPrice(<?php echo $this->getConfig($config['product_id']); ?>);
                                            optionsPrice<?php echo $config['product_id'] . '_' . $value['rule_id']?>.containers[0] = 'promo-product-price-<?php echo $config['product_id'] . '-' . $value['rule_id'];?>';
                                            optionsPrice<?php echo $config['product_id'] . '_' . $value['rule_id']?>.containers[1] = 'promo-bundle-price-<?php echo $config['product_id'] . '-' . $value['rule_id'];?>';
                                            optionsPrice<?php echo $config['product_id'] . '_' . $value['rule_id']?>.containers[2] = 'promo-price-including-tax-<?php echo $config['product_id'] . '-' . $value['rule_id'];?>';
                                            optionsPrice<?php echo $config['product_id'] . '_' . $value['rule_id']?>.containers[3] = 'promo-price-excluding-tax-<?php echo $config['product_id'] . '-' . $value['rule_id'];?>';
                                            optionsPrice<?php echo $config['product_id'] . '_' . $value['rule_id']?>.containers[4] = 'promo-old-price-<?php echo $config['product_id'] . '-' . $value['rule_id'];?>';
                                        </script>
                                        <div class="itoris_groupedproductpromotions_option <?php if ($productData['type_id']=='bundle') {echo 'itoris_grouped_product_bundle';}?>" id="itoris_groupedproductpromo_<?php echo $value['rule_id'] . '_' . $config['product_id'];?>" >
                                            <span class="title-box"><?php echo $this->__('Configure Product') ?></span>
                                            <?php echo $this->optionBlock($config['product_id'], $value['rule_id'])->toHtml();?>
                                        </div>
                                    <?php endif; ?>
                                </div>
                                <?php if ($key != count($value['product_config']) - 1): ?>
                                    <div class="itoris_groupedproductpromotions_plus"><span>+</span></div>
                                <?php endif;?>
                        <?php endforeach; ?>
                        </td>
                        <td style="width: 25%">
                            <div>
                                <span style="font-size: 16px; display: block;"><?php echo $this->__('Price:') . ' ' ?><span class="itoris_groupedproductpromotions_pricevalue"><?php echo Mage::app()->getStore()->formatPrice($totalPrice, false);?></span></span>
                                <span style="font-size: 16px; color: #6A5ACD;"><?php echo $this->__('Discount:') . ' '?><span class="itoris_groupedproductpromotions_pricevalue"><?php echo Mage::app()->getStore()->formatPrice($totalDiscountRule, false)?></span></span>
                                <?php $totalPriceWithDiscount = $totalPrice - $totalDiscountRule; ?>
                                <span style="font-size: 14px; color: black; font-weight: bold; margin: 10px 0 7px 0; display: block;"><?php echo $this->__('Total:') . ' ';?><span class="itoris_groupedproductpromotions_pricevalue"><?php echo Mage::app()->getStore()->formatPrice($totalPriceWithDiscount, false);?></span></span>
                                <button class="button btn-cart" onclick="itorisPromotionsProductAddToCartForm<?php echo $value['rule_id']?>.submit(this, <?php echo $value['rule_id']?>)" title="Add to Cart" type="button">
                                    <span>
                                        <span><?php echo $this->__('Add to Cart');?></span>
                                    </span>
                                </button>
                                <script type="text/javascript">
                                    var itorisPromotionsProductAddToCartForm<?php echo $value['rule_id']?> = new VarienForm('itoris_promotions_product_addtocart_form_<?php echo $value['rule_id']?>');
                                </script>
                            </div>
                        </td>
                    </tr>
                    </table>
                    </form>
                <?php endif; ?>
            <?php endforeach; ?>
    </div>
    <?php endif;?>
    <?php if (Mage::registry('current_product')) : ?>
    <script type="text/javascript">
        if (!opConfig) {
            Product.Options = Class.create();
            Product.Options.prototype = {
                initialize : function(config) {
                    this.config = config;
                    this.reloadPrice();
                    document.observe("dom:loaded", this.reloadPrice.bind(this));
                },
                reloadPrice : function() {}
            };
            var opConfig = new Product.Options(<?php echo Zend_Json::encode(array()); ?>);
        }
        opConfig.reloadPrice = function() {
            var config = this.config;
            var skipIds = [];
            $$('#product_addtocart_form .product-custom-option').each(function(element){
                var optionId = 0;
                element.name.sub(/[0-9]+/, function(match){
                    optionId = parseInt(match[0], 10);
                });
                if (config[optionId]) {
                    var configOptions = config[optionId];
                    var curConfig = {price: 0};
                    if (element.type == 'checkbox' || element.type == 'radio') {
                        if (element.checked) {
                            if (typeof configOptions[element.getValue()] != 'undefined') {
                                curConfig = configOptions[element.getValue()];
                            }
                        }
                    } else if(element.hasClassName('datetime-picker') && !skipIds.include(optionId)) {
                        dateSelected = true;
                        $$('.product-custom-option[id^="options_' + optionId + '"]').each(function(dt){
                            if (dt.getValue() == '') {
                                dateSelected = false;
                            }
                        });
                        if (dateSelected) {
                            curConfig = configOptions;
                            skipIds[optionId] = optionId;
                        }
                    } else if(element.type == 'select-one' || element.type == 'select-multiple') {
                        if ('options' in element) {
                            $A(element.options).each(function(selectOption){
                                if ('selected' in selectOption && selectOption.selected) {
                                    if (typeof(configOptions[selectOption.value]) != 'undefined') {
                                        curConfig = configOptions[selectOption.value];
                                    }
                                }
                            });
                        }
                    } else {
                        if (element.getValue().strip() != '') {
                            curConfig = configOptions;
                        }
                    }
                    if(element.type == 'select-multiple' && ('options' in element)) {
                        $A(element.options).each(function(selectOption) {
                            if (('selected' in selectOption) && typeof(configOptions[selectOption.value]) != 'undefined') {
                                if (selectOption.selected) {
                                    curConfig = configOptions[selectOption.value];
                                } else {
                                    curConfig = {price: 0};
                                }
                                optionsPrice.addCustomPrices(optionId + '-' + selectOption.value, curConfig);
                                optionsPrice.reload();
                            }
                        });
                    } else {
                        optionsPrice.addCustomPrices(element.id || optionId, curConfig);
                        optionsPrice.reload();
                    }
                }
            });
        }
    </script>
    <?php else : ?>
        <script type="text/javascript">
            Product.Options = Class.create();
            Product.Options.prototype = {
                initialize : function(config) {
                    this.config = config;
                    this.reloadPrice();
                    document.observe("dom:loaded", this.reloadPrice.bind(this));
                },
                reloadPrice : function() {}
            };
            var opConfig = new Product.Options(<?php echo Zend_Json::encode(array()); ?>);
        </script>
    <?php endif; ?>
    <?php $usedRules = $this->getUsedRules(); ?>
    <?php if (is_array($usedRules)): ?>
        <?php
            $totalDiscountRule = 0;
            $totalPrice = 0;
        ?>
        <div id="itoris_used_promotion_rules_hidden" style="display: none;">
            <?php foreach ($usedRules as $index => $usedRule): ?>
                <table id="itoris_used_promotion_rule_<?php echo $index ?>" style="width: 100%">
                    <tr><th class="itoris_groupedproductpromotions_title"><?php echo $usedRule['title'];?></th></tr>
                    <tr>
                        <td style="width: 75%; padding: 3px 10px;">
                            <?php $productsData = $this->getProductsData($usedRule, true); ?>
                            <?php foreach ($usedRule['product_config'] as $key => $config): ?>
                                <?php if(isset($productsData[$config['product_id']])) {$productData = $productsData[$config['product_id']]; } else {continue;} ?>
                                <?php
                                $tierPrice = $productData['tier_price'];
                                if (!$tierPrice) {
                                    $totalPrice += $this->getTotalPrice($config['qty'], $productData['final_price']);
                                } else {
                                    $totalPrice += $this->getTotalPrice($config['qty'], $tierPrice);
                                }
                                $totalDiscountRule += $productData['total_discount'];
                                ?>
                                <div class="itoris_groupedproductpromotions_product product_<?php echo $config['product_id'] ?>">
                                    <?php if ($productData['product_url']): ?><a href="<?php echo $productData['product_url'];?>"><?php endif; ?><img src="<?php echo $productData['image'];?>" style="padding-bottom: 5px;"><?php if ($productData['product_url']): ?></a><?php endif; ?>
                                    <div style="font-weight: bold; font-size: 12px"><?php echo $config['qty'] > 1 ? $config['qty'] . ' x ' : '';?><?php if ($productData['product_url']): ?><a href="<?php echo $productData['product_url'];?>"><?php else: ?><span><?php endif; ?><?php echo $productData['name'];?><?php if ($productData['product_url']): ?></a><?php else: ?></span><?php endif; ?></div>
										<span class="itoris_groupedproductpromotions_price">
											<span class="itoris_groupedproductpromotions_pricevalue"><?php echo Mage::app()->getStore()->formatPrice($tierPrice ? $tierPrice : $productData['final_price'], false);?></span>
										</span>
                                    <span style="color: red;"><?php echo $config['qty'] > 1 ? ' x ' . $config['qty'] : '';?></span>

                                    <?php if ($usedRule['price_method'] != 0): ?>
                                        <span class="itoris_groupedproductpromotions_discount"><?php echo Mage::app()->getStore()->formatPrice($productData['discount'], false) . ' ' ; echo $config['qty'] > 1 ?  $this->__('OFF each!') : $this->__('OFF!');?></span>
                                    <?php else: ?>
                                        <?php if ($config['type'] == Itoris_GroupedProductPromotions_Block_Product_View::TYPE_FIXED && $config['discount'] != 0){ ?>
                                            <span class="itoris_groupedproductpromotions_discount"><span class="itoris_groupedproductpromotions_pricevalue"><?php echo Mage::app()->getStore()->formatPrice($productData['discount'], false) . ' ';?></span><?php echo $config['qty'] > 1 ?  $this->__('OFF each!') : $this->__('OFF!');?></span>
                                        <?php } else if ($config['discount'] != 0) { ?>
                                            <span class="itoris_groupedproductpromotions_discount"><?php echo $config['discount'] .'% '; echo $config['qty'] > 1 ?  $this->__('OFF each!') : $this->__('OFF!');?></span>
                                        <?php } ?>
                                    <?php endif;?>
                                </div>
                                <?php if ($key != count($usedRule['product_config']) - 1): ?>
                                    <div class="itoris_groupedproductpromotions_plus"><span>+</span></div>
                                <?php endif;?>
                            <?php endforeach; ?>
                            <div id="itoris_used_promotion_rule_<?php echo $index ?>_qtys" style="display: none;" class="promotion-product-qtys"></div>
                        </td>
                    </tr>
                </table>
            <?php endforeach; ?>
            <script type="text/javascript">
                usedItorisPromotionsRules = <?php echo (Mage::getSingleton('itoris_groupedproductpromotions/quote_observer')->getUsedRulesJson()) ?>;
                document.observe('dom:loaded', function() {
                    var qtyInputs = $$('#shopping-cart-table tr input.qty');
                    var countColumns = $$('#shopping-cart-table tbody tr')[0].select('td').length;
                    var priceColumns = $$('#shopping-cart-table tbody tr')[0].select('td .cart-price').length / 2;
                    var setColumns = countColumns - priceColumns * 2 - 2;
                    var rowTemplate = '<td class="itoris_promotions_row_products" colspan="'+ setColumns +'"></td><td colspan="'+ priceColumns +'" class="rule-price a-center"></td><td class="rule-qty"></td><td colspan="'+ priceColumns +'"  class="rule-total-price a-center"></td><td class="rule-remove"></td>';
                    var removeTemplate = $$('#shopping-cart-table tbody tr')[0].select('td')[countColumns - 1].innerHTML;
					for (var i = 0; i < usedItorisPromotionsRules.length; i++) {
                        var inputsBlock = $('itoris_used_promotion_rule_' + i + '_qtys');
                        for (var j = 0; j < usedItorisPromotionsRules[i].items.length; j++) {
                            for (var z = 0; z < qtyInputs.length; z++) {
                                if (qtyInputs[z].name == 'cart[' + usedItorisPromotionsRules[i].items[j].item_id + '][qty]') {
                                    var row = qtyInputs[z].up('tr');
                                    inputsBlock.appendChild(qtyInputs[z]);
                                    qtyInputs[z].rule_orig_qty = usedItorisPromotionsRules[i].items[j].item_orig_qty;
                                    var itemOptions = row.select('.item-options')[0];
                                    var productBlock = $$('#itoris_used_promotion_rule_' + i + ' .itoris_groupedproductpromotions_product.product_' + usedItorisPromotionsRules[i].items[j].product_id)[0];
                                    if (productBlock) {
                                        if (itemOptions) {
                                           productBlock.insert({after: itemOptions});
                                        }
                                        var productPriceBlock = productBlock.select('.itoris_groupedproductpromotions_price')[0];
                                        if (productPriceBlock) {
                                            productPriceBlock.update(usedItorisPromotionsRules[i].items[j].old_price_formatted);
                                        }
                                    }
                                    row.remove();
                                }
                            }
                        }
                    }

                    var tableBody = $$('#shopping-cart-table tbody')[0];
                    if (tableBody.select('tr.last')[0]) {
                        tableBody.select('tr.last')[0].removeClassName('last');
                    }
                    for (var i = 0; i < usedItorisPromotionsRules.length; i++) {
                        var row = document.createElement('tr');
                        row.innerHTML = rowTemplate;
                        tableBody.appendChild(row);
                        row.select('td')[0].appendChild($('itoris_used_promotion_rule_' + i));
                        var qtyInput = document.createElement('input');
                        qtyInput.type = 'text';
                        qtyInput.className = 'input-text qty';
                        qtyInput.size = 4;
                        qtyInput.value = usedItorisPromotionsRules[i].rule_qty;
                        Event.observe(qtyInput, 'change', changeRuleProductsQtys.bind(this, row, qtyInput, false));
                        row.select('td.rule-qty')[0].appendChild(qtyInput);
                        row.select('td.rule-price')[0].update('<span class="cart-price"><span class="price">' + usedItorisPromotionsRules[i].rule_price_formatted + '</span><span class="itoris_groupedproductpromotions_discount cart">' + usedItorisPromotionsRules[i].rule_discount_formatted + ' <?php echo  addslashes($this->__('OFF')) ?>!</span></span>');
                        row.select('td.rule-total-price')[0].update('<span class="cart-price"><span class="price">' + usedItorisPromotionsRules[i].rule_total_price_formatted + '</span></span>');
                        if (removeTemplate) {
                            var rowRemove = row.select('td.rule-remove')[0];
                            rowRemove.update(removeTemplate);
                            var removeLink = rowRemove.select('a')[0];
                            if (removeLink) {
                                removeLink.href = '#';
                                Event.observe(removeLink, 'click', changeRuleProductsQtys.bind(this, row, {value:0}, true));
                            }
                        }
                        if ($$('.box-itoris-product-promotions')[0]) {
                            var forms = $$('.box-itoris-product-promotions')[0].select('form');

                            for (var j = 0; j < forms.length; j++) {break;
                                var formId = forms[j].id;
                                var formIdSplit = formId.split('_');
                                var idRule = formIdSplit[formIdSplit.length - 1];
                                if (idRule == usedItorisPromotionsRules[i].rule_id) {
                                    forms[j].remove();
                                }
                            }


                        }
                    }
                    if (!$$('.box-itoris-product-promotions')[0].select('form').length) {
                        $$('.box-itoris-product-promotions')[0].remove();
                    }
                });
                function changeRuleProductsQtys(row, qtyInput, updateCart, e) {
                    if (e) {
                        e.stop();
                    }
                    var ruleQty = parseNumber(qtyInput.value);
                    if (isNaN(ruleQty)) {
                        ruleQty = 0;
                    }
                    row.select('.promotion-product-qtys input').each(function(elm){
                        elm.value = ruleQty * elm.rule_orig_qty;
                    });
                    if (updateCart && $$('#shopping-cart-table tfoot .btn-update')[0]) {
                        $$('#shopping-cart-table tfoot .btn-update')[0].click();
                    }
                }
            </script>
        </div>
        <script type="text/javascript">
            var itorisGroupedPromotions = new Itoris.GroupedPromotions(<?php echo Zend_Json::encode($this->getRequest()->getParam('qty'));?>, <?php echo Zend_Json::encode($qtyCurrentProduct);?>, <?php echo Zend_Json::encode($promoDataForJs) ?>);
        </script>
        <?php else: ?>
        <script type="text/javascript">
            var itorisGroupedPromotions = new Itoris.GroupedPromotions(0, 0, <?php echo Zend_Json::encode($promoDataForJs) ?>);
        </script>
    <?php endif; ?>
<?php endif;?>
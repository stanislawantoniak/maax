<?php /* @var $this Zolago_Po_Block_Vendor_Po_Edit_Additem  */?>
<?php $_hlp = Mage::helper("zolagopo");?>
<?php $_po =  $this->getPo();?>
<?php $_currency = $_po->getOrder()->getOrderCurrencyCode();?>
<!-- Modal add letter-->
<div class="modal fade" id="addItemModal">
	<div class="modal-dialog">
		<form id="add-item-form" action="<?php echo $this->getPoUrl("addItem");?>" 
			  class="form-horizontal row-border" method="post">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
					<h4 class="modal-title">
						<?php echo $_hlp->__("Add item");?>
					</h4>
				</div>
				<div class="modal-body">
					<ul class="list-unstyled">
						<li class="form-group">
							<label for="additem-product_id" class="col-md-3 control-label"><?php echo $_hlp->__('Product') ?> <span class="required">*</span></label>
							<div class="col-md-9">
								<input name="product_id" required="required" data-placeholder="<?php echo $_hlp->__('Choose a product') ?>" id="additem-product_id" class="select2-select-00 col-md-12 full-width-fix" type="hidden"/>
							</div>
						</li>
						<li class="form-group product-specified">
							<label for="additem-product_qty" class="col-md-3 control-label"><?php echo $_hlp->__('Qty') ?> <span class="required">*</span></label>
							<div class="col-md-4">
								<input name="product_qty" required="required" id="additem-product_qty" type="text" value="1" min="1" class="form-control required positiveInteger"/> 
							</div>
						</li>
						<li class="form-group product-specified">
							<label for="additem-product_price" class="col-md-3 control-label"><?php echo $_hlp->__('Price') ?> <span class="required">*</span></label>
							<div class="col-md-4">
								<input name="product_price" required="required" id="additem-product_price" type="text" value="" class="form-control pricePositive required numeric"/> 
							</div>
							<div class="col-md-2">
								<div class="after-filed-label text-muted">
									<?php echo $_currency;?>
								</div>
							</div>
						</li>
						<li class="form-group product-specified">
							<label for="additem-product_discount" class="col-md-3 control-label"><?php echo $_hlp->__('Discount') ?></label>
							<div class="col-md-4">
								<input name="product_discount" id="additem-product_discount" type="text" value="" class="form-control pricePositive numeric"/> 
							</div>
							<div class="col-md-4">
								<div class="after-filed-label text-muted">
									<?php echo $_currency;?>
									<span id="dicount-percent" class="text-success"></span>
								</div>
							</div>
						</li>
					</ul>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal"><?php echo $_hlp->__("Cancel");?></button>
					<button type="submit" name="add_own" value="1" class="btn form-btn-loading btn-primary product-specified" data-loading-text="<?php echo $_hlp->__("Loading...");?>"><?php echo $_hlp->__("Add item");?></button>
				</div>
			</div>
		</form>
	</div>
</div>
<script type="text/javascript">
jQuery(function($){
	var currency = '<?php echo $_currency;?>';
	var formatSelection = function(item) { return item.name; };
	var formatResult = function(item) { return item.name + "<br/><small class=\"text-muted\">SKU: " + item.sku +  " &middot;  Price: " + parseFloat(item.price) + " " + currency + "</small>"};
	var form = $("#add-item-form");
	var product = $("#additem-product_id");
	var price = $("#additem-product_price");
	var qty = $("#additem-product_qty");
	var discount = $("#additem-product_discount");
	var timer = null;
	
	var validator = form.validate({
		rules: {
			"product_discount":{
				lessthat: price
			}
		}
	});
	
	product.select2({
		data:				<?php echo $this->getProductCollectionJson();?>,
		id:					"entity_id",
		text:				"name",
		formatSelection:	formatSelection,
		formatResult:		formatResult,
		matcher: function(term, text, opts) { 
			return (''+opts.name).toUpperCase().indexOf((''+term).toUpperCase()) >= 0 || 
				   (''+opts.sku).toUpperCase().indexOf((''+term).toUpperCase()) >= 0
		}
	});
	
	product.change(function(){
		var el = $(this), val = el.val(), item = el.select2('data');
		$("#addItemModal .product-specified").addClass("hidden");
		form[0].reset();
		validator.resetForm();
		if(val){
			$("#addItemModal .product-specified").removeClass("hidden");
			price.val(Zolago.round(item.price));
		}
		precentChange();
	});
	
	var precentChange= function(){
		var value = parseFloat(discount.val());
		var priceValue = parseFloat(price.val());
		
		if(isNaN(value) || value<0){
			value=0;
		}
		
		if(isNaN(priceValue) || priceValue<0){
			priceValue=0;
		}
		
		$("#dicount-percent").html('');
		
		if(value && price && priceValue>value){
			$("#dicount-percent").html('(-' + Math.round(value/priceValue*10000)/100 + '%)');
		}	
	}
	
	
	
	var startTimer = function(){
		timer = setInterval(precentChange, 50);
	}
	
	var stopInterval = function(){
		if(timer){
			clearInterval(timer);
		}
	}
	
	
	discount.focus(startTimer).blur(stopInterval);
	price.focus(startTimer).blur(stopInterval);

	
	$("#addItemModal").on("show.bs.modal", function(){
		product.val("").change();
	});
	
	
});
</script>
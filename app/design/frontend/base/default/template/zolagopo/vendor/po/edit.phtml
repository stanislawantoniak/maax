<?php /* @var $this Zolago_Po_Block_Vendor_Po_Edit */ ?>
<?php $_po = $this->getPo(); ?>
<?php $_hlp = Mage::helper("zolagopo");?>
<?php $_shippingMethod = $this->getShippingMethod();?>
<?php $_shipmentsCollection = $this->getShipmentsCollection();?>
<?php $_currentShipping = $this->getCustomCurrentShipping();?>
<?php $_alert = $_po->getAlert();?>
<?php $_comments = $_po->getVendorCommentsCollection(); ;?>
<?php $_shippingStatuses = Mage::helper('udropship')->getVendorShipmentStatuses(); ?>
<div class="container">
	<!--=== Page Header ===-->
	<div class="page-header">
		<div class="page-title">
			<h3><?php echo $_hlp->__("Order #%s", $_po->getIncrementId());?></h3>
			<?php if(1||$_alert):?>
				<span class="label label-danger" style="display: inline; color: #fff; "><?php echo $_hlp->__("Sample alert text");?></span>
			<?php endif;?>
		</div>
	</div>
</div>
<div class="container">
	<div class="row">
		<div class="col-md-4">
			<div class="widget box">
				<div class="widget-header"> 
					<h4>
						<i class="icon-info"></i> 
						<?php echo $_hlp->__("General");?>
					</h4>
					<div class="toolbar no-padding"> 
						<div class="btn-group"> 
							<span data-toggle="modal" data-target="#changePosModal" class="btn btn-xs">
								<i class="icon-retweet"></i> 
								<?php echo $_hlp->__("Change POS");?>
							</span> 
						</div> 
					</div>
				</div>
				<div class="widget-content orders<?php /* if($_alert):?> with-alert<?php endif;*/ ?>">
					<dl class="dl-horizontal dl-z"> 
						<dt><?php echo $_hlp->__("Number");?>:</dt> 
						<dd><?php echo $_po->getIncrementId();?></dd> 
						<dt><?php echo $_hlp->__("Status");?>:</dt> 
						<dd>
							<div class="btn-group"> 
								<button class="btn btn-xs dropdown-toggle" data-toggle="dropdown"> 
									<?php echo $this->getCurrentStatus($_po);?> <span class="caret"></span> 
								</button> 
								<ul class="dropdown-menu"> 
									<?php foreach($this->getAllowedStatusesForPo($_po) as $key=>$status):?>
										<?php if($key!=$_po->getUdropshipStatus()):?>
										<li><a class="btn-notification" data-placement="top"  data-layout="top" data-type="confirm" data-text="<?php echo $_hlp->__("You are about to change status from %s to %s. Are You sure?", $this->getCurrentStatus($_po), $this->escapeHtml($status));?>" data-modal="true" data-status="<?php echo $key;?>" href="#"><?php echo $this->escapeHtml($status);?></a></li> 
										<?php endif;?>
									<?php endforeach;?>
								</ul> 
							</div>
						</dd> 
						<dt><?php echo $_hlp->__("Order date");?>:</dt> 
						<dd><?php echo Mage::helper('core')->formatDate($_po->getCreatedAt(), 'medium')?></dd> 
						<dt><?php echo $_hlp->__("Max. order date");?>:</dt> 
						<dd><?php echo Mage::helper('core')->formatDate($_po->getCreatedAt(), 'medium')?></dd> 
						<?php if($_po->getPos()):?>
						<dt><?php echo $_hlp->__("POS");?>:</dt> 
						<dd><?php echo $_po->getPos()->getName(); ?></dd> 
						<?php endif;?>
					</dl>
					<?php /* if($_alert):?>
					<p class="alert alert-danger fade in"><?php echo $this->getAlertText($_alert);?></p>
					<?php endif; */?>
				</div>
			</div>
		</div>
		<div class="col-md-4">
			<div class="widget box">
				<div class="widget-header"> <h4><i class="icon-usd"></i> <?php echo $_hlp->__("Payment");?></h4> </div>
				<div class="widget-content orders<?php /* if($_alert):?> with-alert<?php endif; */?>">
					<dl class="dl-horizontal dl-z"> 
						<dt><?php echo $_hlp->__("Payment status");?>:</dt> 
						<dd>Op≈Çacono</dd> 
						<dt><?php echo $_hlp->__("Paid");?>:</dt> 
						<dd>1 034,00 PLN</dd> 
						<dt><?php echo $_hlp->__("Debt");?>:</dt> 
						<dd> 34,00 PLN</dd> 
					</dl>
				</div>
			</div>
		</div>
		<div class="col-md-4">
			<div class="widget box">
				<div class="widget-header"> 
					<h4>
						<i class="icon-phone"></i> 
							<?php echo $_hlp->__("Contact");?>
					</h4> 
					<div class="toolbar no-padding"> 
						<div class="btn-group"> 
							<span data-toggle="modal" data-target="#composeModal"  class="btn btn-xs">
								<i class="icon-comment "></i> 
								<?php echo $_hlp->__("Compose");?>
							</span> 
							
						</div> 
					</div>
				</div>
				<div class="widget-content orders<?php /* if($_alert):?> with-alert<?php endif; */ ?>">
					<dl class="dl-horizontal dl-z"> 
						<dt><?php echo $_hlp->__("Fullname");?>:</dt> 
						<dd><?php echo $this->escapeHtml($_po->getBillingAddress()->getName());?></dd> 
						<dt><?php echo $_hlp->__("Phone");?>:</dt> 
						<dd><?php echo $this->escapeHtml($_po->getBillingAddress()->getTelephone());?></dd> 
						<dt><?php echo $_hlp->__("Messages / new");?></dt> 
						<dd>
							120 / <span class="label label-danger">2</span><br/>
							<a href="#"><?php echo $_hlp->__("View all messages");?></a>
						</dd> 
					</dl>
				</div>
			</div>
		</div>
	</div>
</div>

<div class="container">
	<div class="row">
		<div class="col-md-12">
			<div class="widget box">
				<div class="widget-header"> 
					<h4>
						<i class="icon-list"></i> 
						<?php echo $_hlp->__("Order items");?>
					</h4> 
					<div class="toolbar no-padding"> 
						<div class="btn-group"> 
							<span class="btn btn-xs">
								<i class="icon-ok"></i>
								<?php echo $_hlp->__("Confirm stock");?>
							</span> 
							
							<button data-toggle="modal" data-target="#addItemModal" class="btn btn-xs" >
								<i class="icon-plus-sign"></i>
								<?php echo $_hlp->__("Add new item");?>
							</button>
						</div> 
					</div>
				</div>
				
				<div class="widget-content  no-padding">
					<table id="items" class="table table-striped table-bordered table-checkable table-hover foot-empty-cells">
						<colgroup>
							<col width="50px"/>
							<col width="50px"/>
							<col width="150px"/>
							<col/>
							<col width="50px"/>
							<col width="100px"/>
							<col width="100px"/>
							<col width="100px"/>
							<col width="100px"/>
							<col width="85px"/>
						</colgroup>
						<thead>
							<tr>
								<th class="align-center"><?php echo $_hlp->__("Check");?></th>
								<th class="align-right"><?php echo $_hlp->__("LP");?></th>
								<th><?php echo $_hlp->__("SKU");?></th>
								<th><?php echo $_hlp->__("Product");?></th>
								<th class="align-right"><?php echo $_hlp->__("Qty");?></th>
								<th class="align-right"><?php echo $_hlp->__("Price incl. tax");?></th>
								<th class="align-right"><?php echo $_hlp->__("Discount");?></th>
								<th class="align-right"><?php echo $_hlp->__("Final price");?></th>
								<th class="align-right"><?php echo $_hlp->__("POS Qty");?></th>
								<th></th>
							</tr>
						</thead>
						<tfoot>
							<!-- shipping row -->
							<tr data-item-id="">
								<td colspan="3" rowspan="2" style="vertical-align: middle; border-bottom: 0;">
									<i class="icon-checked-action"></i>
									<button data-toggle="modal" data-target="#splitOrderModal" class="btn" id="split" disabled="disabled">
										<i class=" icon-unlink"></i>
										<?php echo $_hlp->__("Split order");?>
									</button>
								</td>
								
								<?php if($_shippingMethod):?>
								<td colspan="2"><?php echo $_hlp->__("Shipping");?>: <?php echo $this->escapeHtml($this->getMethodName($_shippingMethod));?></td>
								<td class="align-right"><?php echo Mage::helper("core")->currency($_po->getBaseShippingAmountIncl(), true, false);?></td>
								<td class="align-right"><?php echo Mage::helper("core")->currency($_po->getShippingDiscountIncl(), true, false);?></td>
								<td class="align-right"><?php echo Mage::helper("core")->currency($_po->getShippingAmountIncl(), true, false);?></td>
								<?php else:?>
								<td colspan="5"></td>
								<?php endif;?>
								<td></td>
								<td>
									<?php if($_shippingMethod):?>
									<button data-toggle="modal" data-target="#editItemModal" class="btn btn-xs bs-tooltip btn-edit" data-placement="top" title="<?php echo $_hlp->__("Edit item");?>" >
										<i class="icon-pencil"></i>
									</button>
									<button class="btn btn-xs btn-notification bs-tooltip btn-remove" data-placement="top" title="<?php echo $_hlp->__("Remove item");?>" data-layout="top" data-type="confirm" data-text="<?php echo $_hlp->__("Do you want to remove this item?");?>" data-modal="true">
										<i class="icon-remove"></i>
									</button>
									<?php endif;?>
								</td>
							</tr>
							<tr>
								<td colspan="4"><strong> <?php echo $_hlp->__("Total");?></strong></td>
								<td class="align-right"><strong><?php echo Mage::helper("core")->currency($_po->getGrandTotalInclTax());?></strong></td>
								<td colspan="2">
								</td>
							</tr>
						</tfoot>
						<tbody>
							<?php $i=0;?>
							<?php foreach($_po->getAllItems() as $_key=>$_item): ?>
								<?php if(!$_item->getOrderItem()->getParentItemId()):?>
									<?php echo $this->getItemRedener($_item)->setLp(++$i)->toHtml();?>
								<?php endif;?>
							<?php endforeach;?>
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
	<div class="row">
		<div class="col-md-3">
			<div class="widget box">
				<div class="widget-header">
					<h4>
						<i class=" icon-envelope"></i> 
						<?php echo $_hlp->__("Shipping");?>
					</h4>			
					<div class="toolbar no-padding"> 
						<div class="btn-group"> 
							<button class="btn btn-xs" data-address-id="<?php echo $_po->getShippingAddress()->getId();?>" data-toggle="modal" href="#editShippingAddressModal"><i class="icon-pencil"></i></button> 
						</div> 
					</div>
				</div>
				<div class="widget-content bottom-info">
					<?php echo Mage::helper('udropship')->formatCustomerAddress($_po->getShippingAddress(), 'html', $this->getVendor()) ?>
				</div>
			</div>
		</div>
		<div class="col-md-3">
			<div class="widget box">
				<div class="widget-header">
					<h4>
						<i class="icon-file"></i> 
						<?php if($_po->needInvoice()):?>
							<?php echo $_hlp->__("Invoice");?>
						<?php else:?>
							<?php echo $_hlp->__("Bill of sale");?>
						<?php endif;?>
					</h4>
					<div class="toolbar no-padding"> 
						<div class="btn-group"> 
							<button class="btn btn-xs" data-toggle="modal" data-address-id="<?php echo $_po->getBillingAddress()->getId();?>" data-target="#editBillingAddressModal"><i class="icon-pencil"></i></button> 
						</div> 
					</div>
				</div>
				<div class="widget-content bottom-info">
					<?php if($_po->needInvoice()):?>
						<?php echo Mage::helper('udropship')->formatCustomerAddress($_po->getBillingAddress(), 'html', $this->getVendor()) ?>
					<?php else:?>
						<small><?php echo $_hlp->__("Click pencil icon if You need invoice.");?></small>
					<?php endif;?>
				</div>
			</div>
		</div>
		<div class="col-md-6">
			<div class="widget box">
				<div class="widget-header">
					<h4>
						<i class="icon-plane"></i> 
						<?php echo $_hlp->__("Shipment");?>
					</h4>	
					<?php if($_currentShipping && $_currentShipping->getId()):?>
					<div class="toolbar no-padding"> 
						<div class="btn-group"> 
							<span class="btn-notification btn btn-xs" data-placement="top" data-ok-url="<?php echo $this->getPoUrl("cancelShipping", array("shipping_id"=>$_currentShipping->getId()));?>" data-layout="top" data-type="confirm" data-text="<?php echo $_hlp->__("Are You sure?");?>" data-modal="true" href="#">
								<i class="icon-remove "></i> 
								<?php echo $_hlp->__("Cancel");?>
							</span> 
							
						</div> 
					</div>
					<?php endif; ?>
				</div>
				<div class="widget-content bottom-info shipping-info">
					<?php $_tracking = $this->getCurrentTracking($_currentShipping);?>
					<?php if($_currentShipping && $_currentShipping->getId()):?>
					<div class="row">
						<div class="col-md-6">
							<dl class="dl-horizontal dl-z">
								<dt><?php echo $_hlp->__("Status");?>:</dt>
								<dd>
									<?php if(isset($_shippingStatuses[$_currentShipping->getUdropshipStatus()])): ?>
										<?php echo $this->escapeHtml($_shippingStatuses[$_currentShipping->getUdropshipStatus()]);?>
									<?php endif;?>
									<?php echo $_currentShipping->getUdropshipStatus() . " / " . $_currentShipping->getId();?>
								</dd>
								<dt><?php echo $_hlp->__("Method");?>:</dt>
								<dd>
									<?php echo $this->escapeHtml($_currentShipping->getUdropshipMethodDescription());?>
								</dd>
								<dt><?php echo $_hlp->__("Date send");?>:</dt>
								<dd>
									<?php echo $_hlp->__("N/A");?>
								</dd>
							</dl>
						</div>
						<div class="col-md-6">
							<dl class="dl-horizontal dl-z">
								
								<dt><?php echo $_hlp->__("Carrier");?>:</dt>
								<dd>
									<?php if($_tracking && $_tracking->getId()):?>
										<?php echo $this->escapeHtml($_tracking->getTitle());?>
									<?php else:?>
										<?php echo $_hlp->__("N/A");?>
									<?php endif;?>
								</dd>
								<dt><?php echo $_hlp->__("Letter no.");?>:</dt>
								<dd>
									<?php if($_tracking && $_tracking->getId()):?>
										<?php echo $this->escapeHtml($_tracking->getTrackNumber());?>
									<?php else:?>
										<?php echo $_hlp->__("N/A");?>
									<?php endif;?>
								</dd>
								<dt><?php echo $_hlp->__("Aggregated");?>:</dt>
								<dd>
									<?php echo $_hlp->__("N/A");?>
								</dd>
							</dl>
						</div>
					</div>
					<div class="clearfix"></div>
					<?php else:?>
					<div class="align-center">
						<?php if($this->canUseCarrier()):?>
						<button class="btn btn-primary" data-toggle="modal" href="#shippingModal"><?php echo $_hlp->__("Generate shipping letter");?></button>
						<?php else:?>
						<button class="btn btn-primary" data-toggle="modal" href="#shippingModal"><?php echo $_hlp->__("Add shipping letter");?></button>
						<?php endif;?>
					</div>
					<?php endif;?>
				</div>
			</div>
		</div>
	</div>
	<div class="row">
		<div class="col-md-12 comments" id="comments">
			<div class="widget box">
				<div class="widget-header">
					<h4>
						<i class="icon-comments-alt"></i> 
						<?php echo $_hlp->__("Operation history");?>
					</h4>			
					<div class="toolbar no-padding"> 
						<div class="btn-group"> 
							<a class="btn btn-xs btn-default" data-toggle="modal" href="#addCommentModal" id="addCommentModalTrigger"><i class="icon-comment"></i> <?php echo $_hlp->__("Add comment");?></a> 
						</div> 
					</div>
				</div>
				<div class="widget-content">
					<?php if (count($_comments)): ?>
					<dl class="dl-horizontal">
						<?php foreach ($_comments as $_c): ?>
						<dt>
							<?php echo Mage::helper('core')->formatDate($_c->getCreatedAt(), 'medium', true) ?>
							<br/>
							<small><?php echo$_c->getUdropshipStatus();?></small>
						</dt>
						<dd><?php echo $this->htmlEscape($_c->getComment());?></dd>
						
						<?php endforeach ?>
					</dl>
					<?php else:?>
					<small><?php echo $_hlp->__("No comments currently added");?></small>
					<?php endif ?>
				</div>
			</div>
		</div>
	</div>
</div>
<!-- Modals comment -->
<div class="modal fade" id="composeModal">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h4 class="modal-title"><?php echo $_hlp->__("Compose message");?></h4>
			</div>
			<div class="modal-body">
				<form action="<?php Mage::getUrl("*/*/sendCustomerMessage");?>">
					<textarea class="form-control" rows="6"></textarea>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal"><?php echo $_hlp->__("Cancel");?></button>
				<button type="button" class="btn btn-primary" data-dismiss="modal"><?php echo $_hlp->__("Send");?></button>
			</div>
		</div>
	</div>
</div>
<!-- Modal change pos-->
<div class="modal fade" id="changePosModal">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h4 class="modal-title"><?php echo $_hlp->__("Change POS");?></h4>
			</div>
			<div class="modal-body">
				<form action="<?php Mage::getUrl("*/*/changePos");?>">
					Change pos content
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal"><?php echo $_hlp->__("Cancel");?></button>
				<button type="button" class="btn btn-primary" data-dismiss="modal"><?php echo $_hlp->__("Change pos");?></button>
			</div>
		</div>
	</div>
</div>
<!-- Modal add item-->
<div class="modal fade" id="addItemModal">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h4 class="modal-title"><?php echo $_hlp->__("Add item");?></h4>
			</div>
			<div class="modal-body">
				<form action="<?php Mage::getUrl("*/*/addItem");?>">
					Add item content
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal"><?php echo $_hlp->__("Cancel");?></button>
				<button type="button" class="btn btn-primary" data-dismiss="modal"><?php echo $_hlp->__("Add item");?></button>
			</div>
		</div>
	</div>
</div>
<!-- Modal split order-->
<div class="modal fade" id="splitOrderModal">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h4 class="modal-title"><?php echo $_hlp->__("Split order");?></h4>
			</div>
			<div class="modal-body">
				<form action="<?php Mage::getUrl("*/*/splitOrder");?>">
					Dialog content
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal"><?php echo $_hlp->__("Cancel");?></button>
				<button type="button" class="btn btn-primary" data-dismiss="modal"><?php echo $_hlp->__("Split order");?></button>
			</div>
		</div>
	</div>
</div>
<!-- Modal edit item-->
<div class="modal fade" id="editItemModal">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h4 class="modal-title"><?php echo $_hlp->__("Edit item");?></h4>
			</div>
			<div class="modal-body">
				<form action="<?php Mage::getUrl("*/*/saveItem");?>">
					Item fields
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal"><?php echo $_hlp->__("Cancel");?></button>
				<button type="button" class="btn btn-primary" data-dismiss="modal"><?php echo $_hlp->__("Save");?></button>
			</div>
		</div>
	</div>
</div>

<?php 
/*******************************************************************************
 *	Shippign address modal
 *******************************************************************************/
	echo $this->getChild("vendor_po_edit_shipping_address")->
		setAddress($_po->getShippingAddress())->
		toHtml();
?>

<?php 
/*******************************************************************************
 *	Billign address modal
 *******************************************************************************/
	echo $this->getChild("vendor_po_edit_billing_address")->
		setAddress($_po->getBillingAddress())->
		toHtml();
?>


<?php 
/*******************************************************************************
 *	Shipping modal
 *******************************************************************************/
	echo $this->getChild("vendor_po_edit_shipping")->
		setAddress($_po->getShippingAddress())->
		toHtml();
?>

<!-- Modals comment -->
<div class="modal fade" id="addCommentModal">
	<div class="modal-dialog">
		<form action="<?php echo $this->getPoUrl("addComment");?>" method="post">
			<?php echo $this->getFormKey(); ?>
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
					<h4 class="modal-title"><?php echo $_hlp->__("Add comment");?></h4>
				</div>
				<div class="modal-body">
					<textarea class="form-control" name="comment" rows="6" required="required"></textarea>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					<button type="submit" class="btn form-btn-loading btn-primary" data-loading-text="<?php echo $_hlp->__("Loading...");?>"><?php echo $_hlp->__("Add comment");?></button>
				</div>
			</div>
		</form>
	</div>
</div>
<script type="text/javascript">
	jQuery(function($){
		var items = $("#items"),
			checkboxes = items.find(".checker :checkbox"),
			splitBtn = $("#split");
			
		checkboxes.change(function(el){
			var checkLen = checkboxes.filter(":checked").length;
			splitBtn.attr("disabled", /* checkLen==checkboxes.length || */!checkLen);
		});
		$("#addCommentModal").on('shown.bs.modal', function(){
			$(this).find("textarea").focus();
		})
	});
</script>
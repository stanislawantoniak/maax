<?php
/* @var $this GH_Regulation_Block_Dropship_Regulation_Accept */

$_session = Mage::getSingleton('udropship/session');
$_vendor = Mage::registry('reset_vendor');
$_helper = Mage::helper("ghregulation");

?>
<link rel="stylesheet" href="<?php echo Mage::getBaseUrl(); ?>skin/frontend/base/default/font-awesome-4.4.0/css/font-awesome.min.css">
<div class="col-md-8 col-md-offset-2">
    <div class="">
        <div style="margin-top:100px;">
            <div class="row">
                <div class="col-md-12">
                    <?php echo $this->getMessagesBlock()->getGroupedHtml() ?>
                    <form class="form-horizontal" id="accept_regulation_documents_form" action="<?php echo $this->getUrl("*/*/acceptPost"); ?>" method="post" enctype="multipart/form-data">
                        <input name="form_key" type="hidden" value="<?php echo Mage::getSingleton('core/session')->getFormKey() ?>" />
                        <input type="hidden" name="vendor" value="<?php echo $this->getVendor()->getId(); ?>" />
                        <div class="widget box">
                            <div class="widget-header" style="text-align: center;">
                                <h4><?php echo $_helper->__("Accept regulation"); ?></h4>
                            </div>
                            <div class="widget-content">
                                <div class="col-md-12">
                                    <div class="col-md-12">
                                        <?php echo $this->getAcceptBlock(); ?>
                                    </div>
                                </div>
                            <div class="widget-content">
                                <div class="col-md-12">
                                        <p><?php echo $_helper->__("Ja %s oświadczam, że:", $this->getVendor()->getCompanyName()); ?></p>

                                        <label class="css-label">
                                            <input type="checkbox" class="uniform"  name="accept_regulations_single"  />
                                            <?php echo $_helper->__("Jestem upoważniony do jednoosobowego reprezentowania %s", $this->getVendor()->getCompanyName()); ?>
                                        </label>

                                        <label class="css-label">
                                            <input type="checkbox" class="uniform"  name="accept_regulations_proxy" />
                                            <?php echo $_helper->__("Posiadam pełnomocnictwo do zaakceptowania regulaminów MODAGO."); ?>
                                        </label>



                                        <div class="col-md-12"></div>
                                        <div class="add_regulation_document hidden col-md-12">
                                            <label class="css-label">
                                                <?php echo $_helper->__("Załącz skan pełnomocnictwa"); ?>
                                                <input type="file" data-style="fileinput-custom" name="regulation_document" />

                                                <input type="hidden"  name="regulation_document_path" value="" />
                                                <div class="add_regulation_document_preview"></div>
                                            </label>
                                        </div>

                                </div>
                            </div>

                            <?php
                            /* @var $docs GH_Regulation_Model_Resource_Regulation_Document_Collection */
                            $docs = $this->getDocumentsList();
                            ?>


                            <?php if($docs->getSize() > 0): ?>
                                <div class="widget-content">

                                        <div class="col-md-12">
                                            <p><?php echo $_helper->__("Pobierz regulaminy aby zapoznać się z ich treścią:"); ?></p>
                                            <ul class="regulation-docs-list">
                                                <?php foreach ($docs as $doc): ?>
                                                    <?php $data = unserialize($doc->getDocumentLink()); ?>
                                                    <li>
                                                        <?php if($data['type'] == "application/pdf"): ?>
                                                            <i class="fa fa-file-pdf-o fa-lg"></i>
                                                        <?php else: ?>
                                                        <?php endif;?>
                                                        <?php echo $doc->getName(); ?>  <a href="<?php echo $data['path']; ?>" download="<?php echo $data['file_name']; ?>">pobierz</a>
                                                    </li>
                                                <?php endforeach; ?>
                                            </ul>
                                        </div>

                                </div>
                            <?php endif; ?>
                            <div class="widget-content">

                                    <div class="col-md-12">
                                        <p>
                                            <?php echo $_helper->__("Ja %s %s  oświadczam, że", $this->getVendor()->getExecutiveFirstname(), $this->getVendor()->getExecutiveLastname()); ?>
                                        </p>
                                    </div>
                                    <div class="col-md-12">
                                        <label class="css-label">
                                            <input type="checkbox" class="uniform" name="accept_regulations"/>
                                            <?php echo $_helper->__("zapoznałem się regulaminem MODAGO wraz z jego załącznikami oraz akceptuję jego treść co jest jednoznaczne z podpisaniem umowy pomiędzy Zolago Group Sp.z o.o. a %s o świadczeniu usług zgodnie z postanowieniami Regulaminu.", $this->getVendor()->getCompanyName()); ?>
                                        </label>
                                    </div>


                            </div>
                        <div class="form-actions">
                            <button type="submit" id="filter_submit" class="btn btn-primary pull-right" >
                                <span><span><?php echo $_helper->__("Accept regulations"); ?></span></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    jQuery(document).ready(function () {
        handleProxyCheck();
        jQuery("[name='accept_regulations_proxy']").change(function () {
            handleProxyCheck();
        });
    });

    jQuery("#accept_regulation_documents_form").validate({
        rules: {
            accept_regulations: {
                required: true
            },
            'regulation_document': {extension: 'jpe?g,png,pdf', fileSize: 5, required:'[name=accept_regulations_proxy]:checked'}
        },
        messages: {
            'regulation_document': {
                extension: '<?php echo $_helper->__("File must be JPG, PNG or PDF"); ?>',
                fileSize: '<?php echo $_helper->__("File too large. File must be less than %sMB.", GH_Regulation_Helper_Data::REGULATION_DOCUMENT_MAX_SIZE); ?>'
            }
        },
        errorPlacement: function (error, element) {
            element.closest("[class='css-label']").append(error);
        }
    });

    function handleProxyCheck() {
        if (jQuery("[name='accept_regulations_proxy']").is(":checked")) {
            jQuery(".add_regulation_document").removeClass("hidden");
        } else {
            jQuery(".add_regulation_document").addClass("hidden");
        }
    }

    jQuery("input[name=regulation_document]").on('change', function (e) {
        e.preventDefault();
        jQuery(".add_regulation_document_preview").html("");
        jQuery("[name=regulation_document_path]").val("");

        var formData = new FormData(jQuery('#accept_regulation_documents_form')[0]);

        jQuery.ajax({
            url: '<?php echo $this->getSaveVendorDocumentUrl(); ?>',
            type: 'POST',
            data: formData,
            cache: false,
            contentType: false,
            processData: false,
            //dataType: 'json',
            'success': function(response) {},
            'error': function(response) {}
        }).done(function(response){
            if (response.status == 1) {
                jQuery(".add_regulation_document_preview")
                    .html('<a href="' + response.content.link + '" target="_blank">' + response.content.name + '</a>');
                jQuery("[name=regulation_document_path]").val(response.content.link);
            }
            if (response.status == 0) {
                //jQuery(".add_regulation_document_preview").html(response.content);
                jQuery("[name=regulation_document_path]").val("");
            }
        });
    });

    jQuery(document).on('click',"button[type=submit]", function (e) {
        e.preventDefault();

        if(jQuery("form#accept_regulation_documents_form").valid()){
            bootbox.confirm('<?php echo $_helper->__("Are you sure?"); ?>', function (result) {
                if (result) {
                    jQuery("form#accept_regulation_documents_form").submit();
                }
            });
        }
    });
</script>
<style>
    label.error {
        color: #e84c3d;
        font-size: 12px;
        font-weight: normal;
        line-height: 1 !important;
    }
</style>